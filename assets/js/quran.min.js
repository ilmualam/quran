/* IlmuAlam Quran Engine (Enterprise) ¬© 2025 ilmualam.com */
(function () {
  "use strict";

  // ========= Anti-tiru (domain lock) =========
  const OWNER = "ilmualam.com";
  const ALLOW = [
    "ilmualam.com",
    "www.ilmualam.com",
    "ilmualam.blogspot.com",
    "blogger.com/blog/post/preview/",
    "codepen.io/pen",
    "blogger.com",
    "blogspot.com"
  ];
  const host = (location.hostname || "").toLowerCase();
  const okHost = ALLOW.some(d => host === d || host.endsWith("." + d));
  if (!okHost) return;

  const SIGN = "IlmuAlam-QuranEngine::2025-12";

  // ========= Boot =========
  function boot() {
    document.querySelectorAll(".ilmq[data-surah], .ilmhud[data-surah]").forEach(init);
  }

  function init(root) {
    // allow using either class .ilmq (new) or .ilmhud (old)
    if (!root.classList.contains("ilmq")) root.classList.add("ilmq");

    const surah = parseInt(root.getAttribute("data-surah"), 10);
    if (!surah || surah < 1 || surah > 114) return;

    // binds
    const $ = (q) => root.querySelector(q);
    const $$ = (q) => Array.from(root.querySelectorAll(q));

    // required nodes (create if missing)
    let versesEl = $('[data-bind="verses"]') || $("#versesContainer") || root.querySelector(".verses") || null;
    let toastEl = $('[data-bind="toast"]') || $("#toast") || null;
    let audio = $('[data-bind="audio"]') || root.querySelector("audio") || null;

    if (!versesEl) {
      versesEl = document.createElement("div");
      versesEl.className = "verses";
      versesEl.setAttribute("data-bind", "verses");
      root.appendChild(versesEl);
    }
    versesEl.classList.add("verses");
    if (!toastEl) {
      toastEl = document.createElement("div");
      toastEl.className = "toast";
      toastEl.setAttribute("data-bind", "toast");
      toastEl.setAttribute("role", "status");
      toastEl.setAttribute("aria-live", "polite");
      root.appendChild(toastEl);
    }
    if (!audio) {
      audio = document.createElement("audio");
      audio.preload = "metadata";
      audio.crossOrigin = "anonymous";
      audio.setAttribute("data-bind", "audio");
      root.appendChild(audio);
    } else {
      audio.crossOrigin = "anonymous";
    }

    // UI elements (support both markup styles)
    const playBtn = $('[data-action="playpause"]') || $("#playPauseBtn") || null;
    const barWrap = $('[data-action="seek"]') || root.querySelector(".bar") || root.querySelector(".audio-progress") || null;
    const barFill = $('[data-bind="progress"]') || root.querySelector(".progress-bar") || (barWrap ? barWrap.querySelector("i") : null);
    const verseLabel = $('[data-bind="currentVerse"]') || $("#currentVerse") || null;
    const timeLabel = $('[data-bind="time"]') || $("#audioTime") || null;
    const qariSel = $('[data-bind="qari"]') || $("#qariSelector") || null;
// ==== Shorten Qari labels (UI only, value kekal) ====
if (qariSel) {
  const map = {
    "Mishary Rashid Alafasy": "M. R. Alafasy",
    "Abdul Rahman Al-Sudais": "A. R. Sudais",
    "Mahmoud Khalil Al-Husary": "M. K. Husary",
    "Abdul Basit": "Abdul Basit",
    "Saad Al-Ghamadi": "S. Al-Ghamadi"
  };

  Array.from(qariSel.options).forEach(opt => {
    const t = opt.textContent.trim();
    if (map[t]) opt.textContent = map[t];
  });
}
    // settings binds
    const arabicRange = $('[data-bind="arabicSize"]') || $("#arabicSizeSlider") || null;
    const transRange = $('[data-bind="translationSize"]') || $("#translationSizeSlider") || null;
    const autoScrollChk = $('[data-bind="autoScroll"]') || $("#autoScrollToggle") || null;
    const autoNextChk = $('[data-bind="autoNext"]') || $("#autoPlayNextToggle") || null;

    // optional settings panel toggles (details element preferred)
    const settingsBtn = $('[data-action="toggleSettings"]') || $("#settingsToggle") || null;
    const settingsBox = root.querySelector(".settings-content") || $("#settingsContent") || null;

    // tabs + actions (optional, we create if missing)
    ensureEnterpriseToolRow(root);

    const tabs = $$(".tab");
    const modeBtn = root.querySelector('[data-action="mode"]');
    const copyBtn = root.querySelector('[data-action="copy"]');
    const shareBtn = root.querySelector('[data-action="share"]');
    const bmBtn = root.querySelector('[data-action="bookmark"]');
    const resumeBtn = root.querySelector('[data-action="resume"]');

    // meta binds
    const ayahCountBind = root.querySelector('[data-bind="ayahCount"]');
    const revelationBind = root.querySelector('[data-bind="revelation"]');

    // state
    const API = "https://api.alquran.cloud/v1";
    const editions = {
      arabic: "quran-simple-enhanced",
      ms: "ms.basmeih",
      rumi: "en.transliteration"
    };

    const QARI_FALLBACK = [
      "Alafasy_128kbps",
      "Husary_128kbps",
      "Abdul_Basit_Murattal_192kbps",
      "Abdurrahmaan_As-Sudais_192kbps",
      "Ghamadi_40kbps"
    ];

    const storeKey = `ilmq_${surah}`;
    const store = {
      get(k, d) { try { return JSON.parse(localStorage.getItem(`${storeKey}:${k}`)) ?? d; } catch { return d; } },
      set(k, v) { try { localStorage.setItem(`${storeKey}:${k}`, JSON.stringify(v)); } catch {} }
    };

    let verses = [];
    let idx = 0;
    let tab = store.get("tab", "all"); // all | arab | rumi | ms
    let userPaused = true;
    let ready = false;

    // theme mode
    const savedMode = store.get("mode", "auto"); // auto | light | dark
    applyMode(savedMode);

    // font sizes
    const fzA = store.get("fzA", 30);
    const fzT = store.get("fzT", 16);
    root.style.setProperty("--fzA", `${fzA}px`);
    root.style.setProperty("--fzT", `${fzT}`);

    // toggles
    const autoScroll = store.get("autoScroll", true);
    const autoNext = store.get("autoNext", true);

    if (arabicRange) arabicRange.value = fzA;
    if (transRange) transRange.value = fzT;
    if (autoScrollChk) autoScrollChk.checked = !!autoScroll;
    if (autoNextChk) autoNextChk.checked = !!autoNext;

    // footer + watermark (owner DNA)
    ensureFooter(root, SIGN);

    // loading
    versesEl.innerHTML = `<div class="loading">Memuatkan data surah‚Ä¶</div>`;

    // ===== helpers =====
    const pad3 = (n) => String(n).padStart(3, "0");
    const surahPad = pad3(surah);

    const toast = (m) => {
      toastEl.textContent = m;
      toastEl.classList.add("on");
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(() => toastEl.classList.remove("on"), 1400);
    };

    const formatTime = (s) => {
      if (!isFinite(s) || s < 0) return "0:00";
      const m = Math.floor(s / 60), sec = Math.floor(s % 60);
      return `${m}:${String(sec).padStart(2, "0")}`;
    };

    const setPlayUI = (playing) => {
      if (!playBtn) return;
      playBtn.setAttribute("aria-pressed", playing ? "true" : "false");
      playBtn.innerHTML = playing ? "‚è∏" : "‚ñ∂Ô∏è";
    };

    const everyAyahURL = (qari, index0) => `https://everyayah.com/data/${qari}/${surahPad}${pad3(index0 + 1)}.mp3`;

    const testAudio = (url) => new Promise((resolve) => {
      const a = document.createElement("audio");
      let done = false;
      const end = (v) => { if (done) return; done = true; a.removeAttribute("src"); a.load(); resolve(v); };
      const t = setTimeout(() => end(false), 3500);
      a.preload = "metadata";
      a.src = url;
      a.addEventListener("loadedmetadata", () => { clearTimeout(t); end(true); }, { once: true });
      a.addEventListener("error", () => { clearTimeout(t); end(false); }, { once: true });
    });

    async function setAudioWithFallback(index0) {
      const preferred = qariSel?.value || QARI_FALLBACK[0];
      const ordered = [preferred, ...QARI_FALLBACK.filter(q => q !== preferred)];

      for (const qari of ordered) {
        const url = everyAyahURL(qari, index0);
        const ok = await testAudio(url);
        if (ok) {
          audio.dataset.qariUsed = qari;
          audio.src = url;
          audio.load();
          return { ok: true, qari, url };
        }
      }
      return { ok: false };
    }

    function markPlaying(index0) {
      versesEl.querySelectorAll(".v.playing").forEach(n => n.classList.remove("playing"));
      const card = versesEl.querySelector(`.v[data-i="${index0}"]`);
      if (card) card.classList.add("playing");

      // scroll smart only when playing + enabled
      const sc = autoScrollChk ? autoScrollChk.checked : store.get("autoScroll", true);
      if (sc && card) card.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    function applyTab() {
      store.set("tab", tab);
      tabs.forEach(b => b.setAttribute("aria-selected", b.dataset.tab === tab ? "true" : "false"));

      versesEl.querySelectorAll(".v").forEach(card => {
        const a = card.querySelector(".arab");
        const r = card.querySelector(".rumi");
        const m = card.querySelector(".mal");
        if (!a || !r || !m) return;

        a.style.display = (tab === "all" || tab === "arab") ? "" : "none";
        r.style.display = (tab === "all" || tab === "rumi") ? "" : "none";
        m.style.display = (tab === "all" || tab === "ms") ? "" : "none";
      });
    }

    function applyMode(mode) {
      store.set("mode", mode);
      // mode: auto/light/dark
      if (mode === "auto") root.removeAttribute("data-mode");
      else root.setAttribute("data-mode", mode);
      if (modeBtn) modeBtn.textContent = mode === "dark" ? "üåô" : mode === "light" ? "‚òÄÔ∏è" : "üåì";
    }

    function currentAyahText() {
      const v = verses[idx];
      if (!v) return "";
      const parts = [];
      if (tab === "all" || tab === "arab") parts.push(v.arabic);
      if (tab === "all" || tab === "rumi") parts.push(`Rumi: ${v.rumi}`);
      if (tab === "all" || tab === "ms") parts.push(`Maksud: ${v.ms}`);
      return parts.join("\n");
    }

    function saveResume(index0) {
      store.set("resume", { idx: index0, t: Date.now() });
    }

    async function loadAyah(index0, autoplay) {
      idx = Math.max(0, Math.min(verses.length - 1, index0));
      if (verseLabel) verseLabel.textContent = `Ayat ${idx + 1}`;

      markPlaying(idx);
      saveResume(idx);

      const res = await setAudioWithFallback(idx);
      if (!res.ok) {
        setPlayUI(false);
        userPaused = true;
        toast("Audio tiada (semua qari gagal).");
        return;
      }

      if (autoplay) {
        try {
          await audio.play();
          userPaused = false;
          setPlayUI(true);
        } catch {
          userPaused = true;
          setPlayUI(false);
          toast("Klik ‚ñ∂Ô∏è untuk mula main audio.");
        }
      } else {
        userPaused = true;
        setPlayUI(false);
      }
    }

    async function togglePlay() {
      if (!ready) return;
      if (!audio.src) return loadAyah(idx, true);
      if (audio.paused) {
        try { await audio.play(); userPaused = false; setPlayUI(true); }
        catch { toast("Klik ‚ñ∂Ô∏è untuk mula main audio."); }
      } else {
        audio.pause(); userPaused = true; setPlayUI(false);
      }
    }

    // ===== render =====
    function renderVerses() {
      const frag = document.createDocumentFragment();

      verses.forEach((v, i) => {
        const card = document.createElement("article");
        card.className = "v";
        card.dataset.i = String(i);

        card.innerHTML = `
          <div class="top">
            <div class="no">${surah}:${i + 1}</div>
            <div class="va">
              <button class="vbtn p" type="button" data-act="play">${i === idx && !audio.paused ? "Pause" : "Play"}</button>
              <button class="vbtn" type="button" data-act="copy">Copy</button>
              <button class="vbtn" type="button" data-act="bm">‚òÖ</button>
            </div>
          </div>
          <div class="arab" style="font-size:var(--fzA)">${v.arabic}</div>
          <p class="rumi"><strong>Rumi:</strong> ${escapeHTML(v.rumi)}</p>
          <p class="mal"><strong>Maksud:</strong> ${escapeHTML(v.ms)}</p>
        `;

        // click card to play (non-button)
        card.addEventListener("click", (e) => {
          const act = e.target?.dataset?.act;
          if (act) return;
          loadAyah(i, true);
        });

        card.querySelector('[data-act="play"]').addEventListener("click", (e) => {
          e.stopPropagation();
          if (idx !== i) loadAyah(i, true);
          else togglePlay();
        });

        card.querySelector('[data-act="copy"]').addEventListener("click", async (e) => {
          e.stopPropagation();
          await copyText(formatCopy(i));
        });

        card.querySelector('[data-act="bm"]').addEventListener("click", (e) => {
          e.stopPropagation();
          toggleBookmark(i);
        });

        frag.appendChild(card);
      });

      versesEl.innerHTML = "";
      versesEl.appendChild(frag);

      applyTab();
      markPlaying(idx);
      paintBookmarks();
    }

    function escapeHTML(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function formatCopy(i) {
      const v = verses[i];
      return `Surah ${surah}:${i + 1}\n${v.arabic}\nRumi: ${v.rumi}\nMaksud: ${v.ms}\n‚Äî ${OWNER}`;
    }

    async function copyText(text) {
      try {
        await navigator.clipboard.writeText(text);
        toast("Disalin ‚úÖ");
      } catch {
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand("copy"); toast("Disalin ‚úÖ"); } catch { toast("Copy gagal."); }
        ta.remove();
      }
    }

    // bookmarks
    function getBookmarks() { return store.get("bm", []); }
    function setBookmarks(list) { store.set("bm", list); paintBookmarks(); }
    function toggleBookmark(i) {
      const list = new Set(getBookmarks());
      if (list.has(i)) list.delete(i); else list.add(i);
      setBookmarks(Array.from(list).sort((a,b)=>a-b));
      toast(list.has(i) ? "Bookmark ‚òÖ" : "Buang bookmark");
    }
    function paintBookmarks() {
      const list = new Set(getBookmarks());
      versesEl.querySelectorAll(".v").forEach(card => {
        const i = parseInt(card.dataset.i, 10);
        const star = card.querySelector('[data-act="bm"]');
        if (!star) return;
        star.textContent = list.has(i) ? "‚òÖ" : "‚òÜ";
        star.setAttribute("aria-label", list.has(i) ? "Buang bookmark" : "Bookmark ayat");
      });
    }

    // ===== fetch =====
    async function fetchJSON(url) {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`Fetch failed ${r.status}`);
      return r.json();
    }

    async function loadSurah() {
      const aUrl = `${API}/surah/${surah}/${editions.arabic}`;
      const mUrl = `${API}/surah/${surah}/${editions.ms}`;
      const rUrl = `${API}/surah/${surah}/${editions.rumi}`;

      const [A, M, R] = await Promise.all([fetchJSON(aUrl), fetchJSON(mUrl), fetchJSON(rUrl)]);

      const aAy = A?.data?.ayahs || [];
      const mAy = M?.data?.ayahs || [];
      const rAy = R?.data?.ayahs || [];

      verses = aAy.map((x, i) => ({
        arabic: x?.text || "",
        ms: mAy[i]?.text || "",
        rumi: rAy[i]?.text || ""
      }));

      // bind meta if exists
      if (ayahCountBind) ayahCountBind.textContent = String(verses.length);
      if (revelationBind) revelationBind.textContent = (A?.data?.revelationType || "Makkiyyah");

      // resume
      const res = store.get("resume", null);
      idx = res?.idx >= 0 ? Math.min(res.idx, verses.length - 1) : 0;

      ready = true;
      renderVerses();
      await loadAyah(idx, false);

      // first-time hint
      if (!store.get("hint", false)) {
        toast("Tip: Tap ayat untuk main audio.");
        store.set("hint", true);
      }
    }

    // ===== Events =====
    playBtn?.addEventListener("click", togglePlay);

    qariSel?.addEventListener("change", async () => {
      // ==== Shorten Qari labels (UI only, value kekal) ====
function shortenQariLabels(){
  if(!qariSel) return;

  const map = {
    "Mishary Rashid Alafasy": "M. R. Alafasy",
    "Abdul Rahman Al-Sudais": "A. R. Sudais",
    "Mahmoud Khalil Al-Husary": "M. K. Husary",
    "Abdul Basit": "Abdul Basit",
    "Saad Al-Ghamadi": "S. Al-Ghamadi"
  };

  Array.from(qariSel.options).forEach(opt=>{
    const t = opt.textContent.trim();
    if(map[t]) opt.textContent = map[t];
  });
}
shortenQariLabels();
      if (!ready) return;
      const wasPlaying = !audio.paused && !userPaused;
      await loadAyah(idx, wasPlaying);
      toast("Qari ditukar.");
    });

    barWrap?.addEventListener("click", (e) => {
      if (!audio.duration || !isFinite(audio.duration)) return;
      const rect = barWrap.getBoundingClientRect();
      const x = Math.max(0, Math.min(rect.width, e.clientX - rect.left));
      audio.currentTime = (x / rect.width) * audio.duration;
    });

    audio.addEventListener("timeupdate", () => {
      if (!audio.duration || !isFinite(audio.duration)) return;
      const pct = (audio.currentTime / audio.duration) * 100;
      if (barFill) {
        if (barFill.tagName.toLowerCase() === "i") barFill.style.width = pct.toFixed(2) + "%";
        else barFill.style.width = pct.toFixed(2) + "%";
      }
      if (timeLabel) timeLabel.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration)}`;

      // keep aria progress (if exists)
      const prog = root.querySelector('[role="progressbar"]');
      if (prog) prog.setAttribute("aria-valuenow", String(Math.round(pct)));
    });

    audio.addEventListener("play", () => { setPlayUI(true); markPlaying(idx); });
    audio.addEventListener("pause", () => { if (userPaused) setPlayUI(false); });

    audio.addEventListener("ended", async () => {
      setPlayUI(false);
      const nextOn = autoNextChk ? autoNextChk.checked : store.get("autoNext", true);
      if (nextOn && idx + 1 < verses.length) {
        await loadAyah(idx + 1, true);
      } else {
        userPaused = true;
        toast(idx + 1 >= verses.length ? "Tamat surah." : "Auto-next dimatikan.");
      }
    });

    // settings toggle (support both details/hidden UI)
    settingsBtn?.addEventListener("click", () => {
      if (!settingsBox) return;
      const isHidden = settingsBox.hasAttribute("hidden") || settingsBox.style.display === "none";
      if (isHidden) {
        settingsBox.removeAttribute("hidden");
        settingsBox.style.display = "";
        settingsBtn.setAttribute("aria-expanded", "true");
      } else {
        settingsBox.setAttribute("hidden", "");
        settingsBox.style.display = "none";
        settingsBtn.setAttribute("aria-expanded", "false");
      }
    });

    arabicRange?.addEventListener("input", () => {
      const v = parseInt(arabicRange.value, 10) || 30;
      root.style.setProperty("--fzA", `${v}px`);
      store.set("fzA", v);
    });

    transRange?.addEventListener("input", () => {
      const v = parseInt(transRange.value, 10) || 16;
      root.style.setProperty("--fzT", `${v}`);
      store.set("fzT", v);
    });

    autoScrollChk?.addEventListener("change", () => store.set("autoScroll", !!autoScrollChk.checked));
    autoNextChk?.addEventListener("change", () => store.set("autoNext", !!autoNextChk.checked));

    // enterprise tool row actions
    tabs.forEach(b => b.addEventListener("click", () => { tab = b.dataset.tab; applyTab(); }));

    modeBtn?.addEventListener("click", () => {
      const cur = store.get("mode", "auto");
      const next = cur === "auto" ? "dark" : cur === "dark" ? "light" : "auto";
      applyMode(next);
      toast("Mode: " + next);
    });

    copyBtn?.addEventListener("click", async () => {
      await copyText(currentAyahText() || formatCopy(idx));
    });

    shareBtn?.addEventListener("click", async () => {
      const text = formatCopy(idx);
      const url = location.href.split("#")[0] + `#ayah-${surah}-${idx + 1}`;
      try {
        if (navigator.share) {
          await navigator.share({ title: `Surah ${surah}:${idx + 1}`, text, url });
          toast("Dikongsi ‚úÖ");
        } else {
          await copyText(url);
          toast("Link disalin ‚úÖ");
        }
      } catch {
        toast("Share dibatalkan.");
      }
    });

    bmBtn?.addEventListener("click", () => toggleBookmark(idx));

    resumeBtn?.addEventListener("click", async () => {
      const res = store.get("resume", null);
      if (res?.idx >= 0) {
        await loadAyah(res.idx, false);
        toast("Sambung ayat terakhir.");
      } else toast("Tiada rekod sambung.");
    });

    // add hash anchor per ayah for sharing
    window.addEventListener("hashchange", () => {
      const h = (location.hash || "").replace("#", "");
      const m = h.match(/^ayah-(\d+)-(\d+)$/);
      if (!m) return;
      const s = parseInt(m[1], 10), a = parseInt(m[2], 10);
      if (s === surah && a >= 1 && a <= verses.length) loadAyah(a - 1, false);
    });

    // go load
    loadSurah().catch(err => {
      console.error(err);
      versesEl.innerHTML = `<div class="loading">‚ùå Gagal load data. Cuba refresh / semak blocker.<br><small>${String(err?.message || err)}</small></div>`;
      toast("Gagal load data surah.");
    });
  }

  // ===== UI injectors =====
  function ensureEnterpriseToolRow(root) {
    if (root.querySelector(".tools")) return;

    const row = document.createElement("div");
    row.className = "tools";
    row.innerHTML = `
      <div class="tabs" role="tablist" aria-label="Paparan">
        <button class="tab" data-tab="all" aria-selected="true" type="button">Semua</button>
        <button class="tab" data-tab="arab" aria-selected="false" type="button">Arab</button>
        <button class="tab" data-tab="rumi" aria-selected="false" type="button">Rumi</button>
        <button class="tab" data-tab="ms" aria-selected="false" type="button">Melayu</button>
      </div>
      <div class="act" aria-label="Tindakan">
        <button class="chip" data-action="mode" type="button" title="Tukar mode">üåì</button>
        <button class="chip" data-action="resume" type="button" title="Sambung ayat terakhir">‚èØ</button>
        <button class="chip" data-action="bookmark" type="button" title="Bookmark ayat semasa">‚òÖ</button>
        <button class="chip" data-action="copy" type="button" title="Copy ayat semasa">‚éò</button>
        <button class="chip" data-action="share" type="button" title="Share ayat semasa">'\uE800'</button>
      </div>
    `;

    // inject after player if exists
    const after = root.querySelector(".player") || root.querySelector(".audio-controls") || root.firstElementChild;
    if (after && after.parentNode === root) {
      after.insertAdjacentElement("afterend", row);
    } else {
      root.insertAdjacentElement("afterbegin", row);
    }

    // make sure progress fill has <i> if needed
    const bar = root.querySelector(".bar");
    if (bar && !bar.querySelector("i")) {
      const i = document.createElement("i");
      bar.appendChild(i);
    }

    // if play button empty, style it
    const pp = root.querySelector(".pp") || root.querySelector('[data-action="playpause"]') || root.querySelector("#playPauseBtn");
    if (pp && !pp.textContent.trim()) pp.textContent = "‚ñ∂Ô∏è";
  }

  function ensureFooter(root, sign) {
    if (root.querySelector(".foot")) return;
    const foot = document.createElement("footer");
    foot.className = "foot";
    foot.innerHTML = `
      <span>¬© 2025 <strong><a href="https://www.ilmualam
      com" target="_blank">IlmuAlam.com</a></strong> ‚Ä¢ Quran Reader</span>
    `;
    root.appendChild(foot);
  }

  // ===== init wrapper =====
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", boot);
  else boot();
})();
