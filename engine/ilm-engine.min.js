(()=> {
  const LOCK_HOSTS=["ilmualam.com","www.ilmualam.com","localhost","127.0.0.1"];
  const OWNER="IlmuAlam.com";
  const OWNER_URL="https://www.ilmualam.com/";
  const ENGINES=document.querySelectorAll(".ilmEngine");
  if(!ENGINES.length) return;
  const safeHost=()=>LOCK_HOSTS.includes(location.hostname);

  const clean=s=>(s||"").toString().trim();
  const jsonParse=(s,f)=>{try{return JSON.parse(s)}catch(e){return f}};
  const today=()=>{const d=new Date();const p=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;};

  const meta = {
    get: (name)=> clean(document.querySelector(`meta[name="${name}"]`)?.content),
    prop: (p)=> clean(document.querySelector(`meta[property="${p}"]`)?.content),
    canonical: ()=> clean(document.querySelector('link[rel="canonical"]')?.href) || location.href.split("#")[0],
    title: ()=> meta.prop("og:title") || document.title || "",
    desc: ()=> meta.prop("og:description") || meta.get("description") || "",
    image: ()=> meta.prop("og:image") || ""
  };

  const firstImageFallback = ()=>{
    const img=document.querySelector('article img, .post-body img, .entry-content img, img');
    return clean(img?.src);
  };

  const detectYouTube = ()=>{
    const iframe=document.querySelector('iframe[src*="youtube.com/embed/"],iframe[src*="youtube-nocookie.com/embed/"]');
    if(!iframe) return null;
    const src=clean(iframe.getAttribute("src"));
    const m=src.match(/\/embed\/([a-zA-Z0-9_-]{6,})/);
    const id=m?m[1]:null;
    return {embedUrl: src, id};
  };

  const detectVideoSelfHost = ()=>{
    const v=document.querySelector("video source[src], video[src]");
    const url=clean(v?.getAttribute("src") || v?.querySelector("source")?.getAttribute("src"));
    return url ? {contentUrl:url} : null;
  };

  const injectOnce=(key,obj)=>{
    if(document.querySelector(`script[data-ilm-engine="${key}"]`)) return;
    const s=document.createElement("script");
    s.type="application/ld+json";
    s.setAttribute("data-ilm-engine",key);
    s.textContent=JSON.stringify(obj);
    document.head.appendChild(s);
  };

  const mkBreadcrumb=(type,url,custom)=>{
    if(custom && custom.length){
      return {
        "@type":"BreadcrumbList",
        "@id":url+"#breadcrumb",
        "itemListElement":custom.map((it,i)=>({
          "@type":"ListItem",
          "position":i+1,
          "name":it[0],
          "item":(it[1]==="AUTO")?url:it[1]
        }))
      };
    }
    // default breadcrumb by type
    const map = {
      quran_surah: [
        ["Utama", OWNER_URL],
        ["Al-Quran Online", OWNER_URL+"p/quran-online.html"],
        ["Halaman", "AUTO"]
      ],
      ruqyah_pack: [
        ["Utama", OWNER_URL],
        ["Ruqyah", OWNER_URL+"search/label/ruqyah"],
        ["Halaman", "AUTO"]
      ],
      directory_list: [
        ["Utama", OWNER_URL],
        ["Direktori", OWNER_URL+"p/direktori.html"],
        ["Halaman", "AUTO"]
      ],
      tool_app: [
        ["Utama", OWNER_URL],
        ["Tools", OWNER_URL+"p/tools.html"],
        ["Halaman", "AUTO"]
      ],
      article_pillar: [
        ["Utama", OWNER_URL],
        ["Panduan", OWNER_URL+"search/label/panduan"],
        ["Halaman", "AUTO"]
      ]
    };
    const arr = map[type] || [["Utama", OWNER_URL], ["Halaman","AUTO"]];
    return mkBreadcrumb(type,url,arr);
  };

  const mkFAQ=(pairs,url)=>{
    if(!pairs || !pairs.length) return null;
    return {
      "@type":"FAQPage",
      "@id":url+"#faq",
      "mainEntity":pairs.map(p=>({
        "@type":"Question",
        "name":p[0],
        "acceptedAnswer":{"@type":"Answer","text":p[1]}
      }))
    };
  };

  const mkHowTo=(steps,url,name)=>{
    if(!steps || !steps.length) return null;
    return {
      "@type":"HowTo",
      "@id":url+"#howto",
      "name":name || "Cara Guna",
      "inLanguage":"ms",
      "step":steps.map(s=>({"@type":"HowToStep","name":s[0],"text":s[1]}))
    };
  };

  const smartKeywords=(type,title,surahNum)=>{
    const t=title.toLowerCase();
    const out=[];
    const push=(...a)=>a.forEach(x=>x&&out.push(x));
    if(type==="quran_surah"){
      push("surah","rumi","terjemahan melayu","audio ayat demi ayat","bacaan");
      if(surahNum) push(`surah ${surahNum}`);
      if(t.includes("lengkap")) push("surah lengkap");
    } else if(type==="ruqyah_pack"){
      push("ruqyah","3 qul","surah perlindungan","sebelum tidur","audio ruqyah","kids mode","slow mode");
    } else if(type==="directory_list"){
      push("direktori","senarai","alamat","nombor telefon","near me","peta");
    } else if(type==="local_place"){
      push("lokasi","telefon","peta","waktu operasi","near me");
    } else if(type==="tool_app"){
      push("tool","kalkulator","generator","online","percuma");
    } else {
      push("panduan","lengkap","cara","rujukan");
    }
    return [...new Set(out)].slice(0,12);
  };

  const sabotage=(el)=>{
    el.innerHTML=`<div style="border:1px solid #e5e5e5;border-radius:14px;padding:14px;font-family:system-ui">
      <b>ðŸ”’ Akses dikunci</b><br>Komponen ini aktif di domain rasmi ${OWNER} sahaja.
    </div>`;
  };

  const autoscanPatch=()=>{
    // theme kadang sembunyikan checkbox/label
    document.querySelectorAll("label.chk, .setting-item label").forEach(l=>{
      l.style.visibility="visible"; l.style.opacity="1";
    });
  };

  ENGINES.forEach(el=>{
    if(!safeHost()){ sabotage(el); return; }

    const type=clean(el.getAttribute("data-type")) || "tool_app";
    const surah=clean(el.getAttribute("data-surah")) || "";
    const url=meta.canonical();

    // AUTO metadata (if attribute missing)
    const title=clean(el.getAttribute("data-title")) || meta.title() || "IlmuAlam";
    const desc =clean(el.getAttribute("data-desc"))  || meta.desc()  || "Alat interaktif IlmuAlam.";
    const imgA =clean(el.getAttribute("data-image")) || meta.image() || firstImageFallback();

    const bc =jsonParse(el.getAttribute("data-breadcrumb")||"[]", []);
    const faq=jsonParse(el.getAttribute("data-faq")||"[]", []);
    const how=jsonParse(el.getAttribute("data-howto")||"[]", []);

    // lightweight header card (optionalâ€”kau boleh buang kalau tak nak)
    el.innerHTML = `
      <div style="max-width:900px;margin:14px auto;padding:0 10px;font-family:system-ui;color:#0c3808">
        <div style="border:1px solid rgba(12,56,8,.12);border-radius:16px;overflow:hidden;box-shadow:0 12px 28px rgba(0,0,0,.08);background:#fff">
          <div style="background:linear-gradient(135deg,#249749,#0c3808);color:#fff;padding:14px 14px">
            <div style="font-weight:900;font-size:.93rem;opacity:.92">${(bc&&bc.length)?bc.map((x,i)=>`<a href="${x[1]==="AUTO"?url:x[1]}" style="color:#fff;text-decoration:underline">${x[0]}</a>${i<bc.length-1?" / ":""}`).join(""):""}</div>
            <h2 style="margin:6px 0 0;font-size:1.12rem;line-height:1.25">${title}</h2>
            <p style="margin:8px 0 0;opacity:.92;line-height:1.5">${desc}</p>
            <div style="display:inline-flex;gap:8px;align-items:center;font-weight:900;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:999px;margin-top:10px">âš¡ SERP Engine â€¢ Â© ${OWNER}</div>
          </div>
        </div>
      </div>
    `;

    // Build graph
    const d=today();
    const kw=smartKeywords(type,title,surah);

    const graph=[];
    graph.push({
      "@type":"WebPage",
      "@id":url+"#webpage",
      "url":url,
      "name":title,
      "isPartOf":{"@id":OWNER_URL+"#website"},
      "inLanguage":"ms",
      ...(imgA?{"primaryImageOfPage":{"@type":"ImageObject","url":imgA}}:{})
    });

    graph.push({
      "@type":"WebApplication",
      "@id":url+"#app",
      "name":title,
      "applicationCategory":"EducationalApplication",
      "operatingSystem":"All",
      "isAccessibleForFree":true,
      "url":url,
      "publisher":{"@type":"Organization","name":OWNER,"url":OWNER_URL}
    });

    graph.push({
      "@type":"Article",
      "@id":url+"#article",
      "headline":title,
      "description":desc,
      ...(imgA?{"image":[imgA]}:{}),
      "datePublished":d,
      "dateModified":d,
      "mainEntityOfPage":{"@id":url+"#webpage"},
      "author":{"@type":"Organization","name":OWNER,"url":OWNER_URL},
      "publisher":{"@type":"Organization","name":OWNER,"url":OWNER_URL},
      "inLanguage":"ms",
      "keywords":kw
    });

    // Quran entity helper (optional)
    if(type==="quran_surah" && surah){
      graph.push({
        "@type":"Thing",
        "@id":url+"#entity",
        "name":title,
        "sameAs":[`https://quran.com/${surah}`]
      });
    }

    // Breadcrumb
    graph.push(mkBreadcrumb(type,url,bc));

    // FAQ/HowTo if provided
    const faqObj=mkFAQ(faq,url); if(faqObj) graph.push(faqObj);
    const howObj=mkHowTo(how,url,`Cara guna: ${title}`); if(howObj) graph.push(howObj);

    injectOnce("graph", {"@context":"https://schema.org","@graph":graph});

    // Auto VideoObject (first YouTube or self-hosted video)
    const yt=detectYouTube();
    const sh=detectVideoSelfHost();
    if(yt || sh){
      const thumb = yt?.id ? `https://i.ytimg.com/vi/${yt.id}/hqdefault.jpg` : (imgA||"");
      const vid = {
        "@context":"https://schema.org",
        "@type":"VideoObject",
        "name": title,
        "description": desc,
        ...(thumb?{"thumbnailUrl":[thumb]}:{}),
        "uploadDate": d,
        ...(yt?{"embedUrl": yt.embedUrl}:{}),
        ...(sh?{"contentUrl": sh.contentUrl}:{}),
        "publisher":{"@type":"Organization","name":OWNER,"url":OWNER_URL}
      };
      injectOnce("video", vid);
    }

    autoscanPatch();
  });
})();
