(()=> {
  "use strict";

  /* ========= CONFIG ========= */
  const OWNER="IlmuAlam.com";
  const OWNER_URL="https://www.ilmualam.com/";
  const LOCK_HOSTS=["ilmualam.com","www.ilmualam.com","localhost","127.0.0.1"];

  // Set false kalau kau tak nak header card auto (UI)
  const ENABLE_HEADER_CARD = true;

  const MAX_FAQ = 12;
  const MAX_HOWTO = 10;

  /* ========= HELPERS ========= */
  const clean = s => (s||"").toString().replace(/\s+/g," ").trim();
  const safeHost = () => LOCK_HOSTS.includes(location.hostname);

  const jsonParse=(s,f)=>{ try{ return JSON.parse(s); }catch{ return f; } };
  const today=()=>{
    const d=new Date(); const p=n=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`;
  };

  const meta = {
    get: (name)=> clean(document.querySelector(`meta[name="${name}"]`)?.content),
    prop:(p)=> clean(document.querySelector(`meta[property="${p}"]`)?.content),
    canonical:()=> clean(document.querySelector('link[rel="canonical"]')?.href) || location.href.split("#")[0],
    title:()=> meta.prop("og:title") || document.title || "",
    desc: ()=> meta.prop("og:description") || meta.get("description") || "",
    image:()=> meta.prop("og:image") || ""
  };

  const firstImageFallback = ()=>{
    const img = document.querySelector('article img, .post-body img, .entry-content img, img');
    return clean(img?.src);
  };

  const detectYouTube = ()=>{
    const iframe = document.querySelector('iframe[src*="youtube.com/embed/"],iframe[src*="youtube-nocookie.com/embed/"]');
    if(!iframe) return null;
    const src = clean(iframe.getAttribute("src"));
    const m = src.match(/\/embed\/([a-zA-Z0-9_-]{6,})/);
    const id = m ? m[1] : null;
    return {embedUrl: src, id};
  };

  const detectSelfHostVideo = ()=>{
    const v = document.querySelector("video source[src], video[src]");
    const url = clean(v?.getAttribute("src") || v?.querySelector("source")?.getAttribute("src"));
    return url ? {contentUrl:url} : null;
  };

  const injectOnce=(key,obj)=>{
    if(document.querySelector(`script[data-ilm-engine="${key}"]`)) return;
    const s=document.createElement("script");
    s.type="application/ld+json";
    s.setAttribute("data-ilm-engine",key);
    s.textContent=JSON.stringify(obj);
    document.head.appendChild(s);
  };

  const mkBreadcrumb=(type,url,custom)=>{
    const arr = (custom && custom.length) ? custom : (()=>{
      const map = {
        quran_surah: [["Utama",OWNER_URL],["Al-Quran Online",OWNER_URL+"p/quran-online.html"],["Halaman","AUTO"]],
        ruqyah_pack:[["Utama",OWNER_URL],["Ruqyah",OWNER_URL+"search/label/ruqyah"],["Halaman","AUTO"]],
        directory_list:[["Utama",OWNER_URL],["Direktori",OWNER_URL+"p/direktori.html"],["Halaman","AUTO"]],
        tool_app: [["Utama",OWNER_URL],["Tools",OWNER_URL+"p/tools.html"],["Halaman","AUTO"]],
        article_pillar:[["Utama",OWNER_URL],["Panduan",OWNER_URL+"search/label/panduan"],["Halaman","AUTO"]]
      };
      return map[type] || [["Utama",OWNER_URL],["Halaman","AUTO"]];
    })();

    return {
      "@type":"BreadcrumbList",
      "@id":url+"#breadcrumb",
      "itemListElement":arr.map((it,i)=>({
        "@type":"ListItem",
        "position":i+1,
        "name":it[0],
        "item":(it[1]==="AUTO")?url:it[1]
      }))
    };
  };

  const smartKeywords=(type,title,surahNum)=>{
    const t=clean(title).toLowerCase();
    const out=[];
    const push=(...a)=>a.forEach(x=>x&&out.push(clean(x)));
    if(type==="quran_surah"){
      push("surah","bacaan","rumi","terjemahan melayu","audio ayat demi ayat","mp3");
      if(surahNum) push(`surah ${surahNum}`);
      if(t.includes("lengkap")) push("surah lengkap");
    } else if(type==="ruqyah_pack"){
      push("ruqyah","3 qul","surah perlindungan","sebelum tidur","audio ruqyah","kids mode","slow mode");
    } else if(type==="directory_list"){
      push("direktori","senarai","alamat","nombor telefon","near me","peta","waktu operasi");
    } else if(type==="tool_app"){
      push("tool","kalkulator","generator","online","percuma");
    } else {
      push("panduan","cara","lengkap","rujukan");
    }
    return [...new Set(out)].slice(0,12);
  };

  const mkFAQ=(pairs,url)=>{
    if(!pairs || !pairs.length) return null;
    return {
      "@type":"FAQPage",
      "@id":url+"#faq",
      "mainEntity":pairs.map(p=>({
        "@type":"Question",
        "name":clean(p[0]),
        "acceptedAnswer":{"@type":"Answer","text":clean(p[1])}
      }))
    };
  };

  const mkHowTo=(steps,url,name)=>{
    if(!steps || !steps.length) return null;
    return {
      "@type":"HowTo",
      "@id":url+"#howto",
      "name":name || "Cara Guna",
      "inLanguage":"ms",
      "step":steps.map(s=>({
        "@type":"HowToStep",
        "name":clean(s[0]),
        "text":clean(s[1])
      }))
    };
  };

  /* ========= AUTO SCANNERS (post lama) ========= */
  const autoExtractFAQ = ()=>{
    const root =
      document.querySelector("#faq") ||
      document.querySelector(".faq-schema") ||
      document.querySelector(".faq-tool") ||
      document.body;

    const pairs=[];
    root.querySelectorAll("h3, h4").forEach(h=>{
      const q=clean(h.textContent);
      if(!q) return;

      let p=h.nextElementSibling;
      while(p && !["P","DIV","UL","OL"].includes(p.tagName)) p=p.nextElementSibling;

      let a="";
      if(p){
        if(p.tagName==="UL" || p.tagName==="OL"){
          a = Array.from(p.querySelectorAll("li")).map(li=>clean(li.textContent)).filter(Boolean).join(" ");
        } else {
          a = clean(p.textContent);
        }
      }
      if(q && a) pairs.push([q,a]);
    });

    return pairs.slice(0, MAX_FAQ);
  };

  const autoExtractHowTo = ()=>{
    // Cari list steps paling â€œbernilaiâ€
    const candidates = [
      document.querySelector("#cara"),
      document.querySelector("#howto"),
      document.querySelector("section[id*='cara' i]"),
      document.querySelector("section[id*='how' i]"),
      document.querySelector(".howto"),
      document.querySelector(".ilm-howto"),
      document.querySelector(".ilm-sec"),
      document.body
    ].filter(Boolean);

    let best=null, bestCount=0;

    candidates.forEach(c=>{
      c.querySelectorAll("ol, ul").forEach(list=>{
        const items = Array.from(list.querySelectorAll("li"))
          .map(li=>clean(li.textContent))
          .filter(Boolean);

        // minimum 3 step supaya valid HowTo
        if(items.length>=3 && items.length>bestCount){
          best=items;
          bestCount=items.length;
        }
      });
    });

    if(!best) return [];
    return best.slice(0, MAX_HOWTO).map((t,i)=>[`Langkah ${i+1}`, t]);
  };

  /* ========= THEME CONFLICT PATCH (checkbox/labels hidden) ========= */
  const autoscanPatchUI = ()=>{
    // Pastikan label/toggle tak kena display:none / opacity:0 oleh theme
    document.querySelectorAll("label, .setting-item, .settings-content").forEach(el=>{
      if(!el) return;
      // jangan override hard; set minimum visibility only
      el.style.visibility = "visible";
      el.style.opacity = "1";
    });
  };

  const sabotage=(el)=>{
    el.innerHTML = `
      <div style="border:1px solid rgba(12,56,8,.18);border-radius:14px;padding:14px;font-family:system-ui;background:#fff">
        <b>ðŸ”’ SERP Engine dikunci</b><br>
        Komponen ini aktif di domain rasmi <b>${OWNER}</b> sahaja.
      </div>`;
  };

  const renderHeaderCard=(el,title,desc,bc,url)=>{
    if(!ENABLE_HEADER_CARD) return;
    const crumbs = (bc && bc.length)
      ? bc.map((x,i)=>`<a href="${x[1]==="AUTO"?url:x[1]}" style="color:#fff;text-decoration:underline">${x[0]}</a>${i<bc.length-1?" / ":""}`).join("")
      : "";

    el.innerHTML = `
      <div style="max-width:900px;margin:14px auto;padding:0 10px;font-family:system-ui;color:#0c3808">
        <div style="border:1px solid rgba(12,56,8,.12);border-radius:16px;overflow:hidden;box-shadow:0 12px 28px rgba(0,0,0,.08);background:#fff">
          <div style="background:linear-gradient(135deg,#249749,#0c3808);color:#fff;padding:14px 14px">
            ${crumbs?`<div style="font-weight:900;font-size:.92rem;opacity:.92">${crumbs}</div>`:""}
            <h2 style="margin:6px 0 0;font-size:1.12rem;line-height:1.25">${title}</h2>
            <p style="margin:8px 0 0;opacity:.92;line-height:1.5">${desc}</p>
            <div style="display:inline-flex;gap:8px;align-items:center;font-weight:900;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);padding:6px 10px;border-radius:999px;margin-top:10px">âš¡ SERP Engine â€¢ Â© ${OWNER}</div>
          </div>
        </div>
      </div>`;
  };

  /* ========= MAIN ========= */
  const ENGINES=document.querySelectorAll(".ilmEngine");
  if(!ENGINES.length) return;

  ENGINES.forEach(el=>{
    if(!safeHost()){ sabotage(el); return; }

    const type = clean(el.getAttribute("data-type")) || "tool_app";
    const surah = clean(el.getAttribute("data-surah")) || "";
    const url = meta.canonical();

    const bcAttr = jsonParse(el.getAttribute("data-breadcrumb")||"[]", []);
    let faq = jsonParse(el.getAttribute("data-faq")||"[]", []);
    let how = jsonParse(el.getAttribute("data-howto")||"[]", []);

    // AUTO SCAN fallback utk post lama
    if(!faq.length) faq = autoExtractFAQ();
    if(!how.length) how = autoExtractHowTo();

    // AUTO metadata
    const title = clean(el.getAttribute("data-title")) || meta.title() || OWNER;
    const desc  = clean(el.getAttribute("data-desc"))  || meta.desc()  || `Rujukan & alat interaktif oleh ${OWNER}.`;
    const imgA  = clean(el.getAttribute("data-image")) || meta.image() || firstImageFallback();

    renderHeaderCard(el,title,desc,bcAttr,url);

    const d = today();
    const kw = smartKeywords(type,title,surah);

    const graph=[];

    graph.push({
      "@type":"WebSite",
      "@id":OWNER_URL+"#website",
      "name":OWNER,
      "url":OWNER_URL
    });

    graph.push({
      "@type":"WebPage",
      "@id":url+"#webpage",
      "url":url,
      "name":title,
      "isPartOf":{"@id":OWNER_URL+"#website"},
      "inLanguage":"ms",
      ...(imgA?{"primaryImageOfPage":{"@type":"ImageObject","url":imgA}}:{})
    });

    graph.push({
      "@type":"WebApplication",
      "@id":url+"#app",
      "name":title,
      "applicationCategory":"EducationalApplication",
      "operatingSystem":"All",
      "isAccessibleForFree":true,
      "url":url,
      "publisher":{"@type":"Organization","name":OWNER,"url":OWNER_URL}
    });

    graph.push({
      "@type":"Article",
      "@id":url+"#article",
      "headline":title,
      "description":desc,
      ...(imgA?{"image":[imgA]}:{}),
      "datePublished":d,
      "dateModified":d,
      "mainEntityOfPage":{"@id":url+"#webpage"},
      "author":{"@type":"Organization","name":OWNER,"url":OWNER_URL},
      "publisher":{"@type":"Organization","name":OWNER,"url":OWNER_URL},
      "inLanguage":"ms",
      "keywords":kw
    });

    // Optional entity link (Quran.com)
    if(type==="quran_surah" && surah){
      graph.push({
        "@type":"Thing",
        "@id":url+"#entity",
        "name":title,
        "sameAs":[`https://quran.com/${surah}`]
      });
    }

    // Breadcrumb
    graph.push(mkBreadcrumb(type,url,bcAttr));

    // FAQ & HowTo
    const faqObj = mkFAQ(faq,url); if(faqObj) graph.push(faqObj);
    const howObj = mkHowTo(how,url,`Cara guna: ${title}`); if(howObj) graph.push(howObj);

    injectOnce("graph", {"@context":"https://schema.org","@graph":graph});

    // Auto VideoObject (YouTube / self-hosted)
    const yt = detectYouTube();
    const sh = detectSelfHostVideo();
    if(yt || sh){
      const thumb = yt?.id ? `https://i.ytimg.com/vi/${yt.id}/hqdefault.jpg` : (imgA||"");
      const vid = {
        "@context":"https://schema.org",
        "@type":"VideoObject",
        "name": title,
        "description": desc,
        ...(thumb?{"thumbnailUrl":[thumb]}:{}),
        "uploadDate": d,
        ...(yt?{"embedUrl": yt.embedUrl}:{}),
        ...(sh?{"contentUrl": sh.contentUrl}:{}),
        "publisher":{"@type":"Organization","name":OWNER,"url":OWNER_URL}
      };
      injectOnce("video", vid);
    }

    autoscanPatchUI();
  });
})();
