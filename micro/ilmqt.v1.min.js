/*! Micro Quran Trainer v1 | Â© IlmuAlam.com | Locked + AutoScan */
(()=>{const OWNER="IlmuAlam.com",OWNER_URL="https://www.ilmualam.com/";const LOCK_HOSTS=["www.ilmualam.com","ilmualam.com","localhost","127.0.0.1"];const safeHost=()=>LOCK_HOSTS.includes(location.hostname);

/* ===== Auto Scan Mode (Entity + BIDI) ===== */
const __ILM_FIX=(()=>{const decode=s=>{if(!s)return s;s=String(s)
.replace(/&amp;#(\d+);/g,(_,n)=>String.fromCharCode(+n))
.replace(/&#(\d+);/g,(_,n)=>String.fromCharCode(+n))
.replace(/8226#&/g,"â€¢")
.replace(/&\#8226;|&#8226;|&amp;#8226;/g,"â€¢")
.replace(/&\#169;|&#169;|&amp;#169;/g,"Â©");return s;};
const iso=s=>s?`\u2068${s}\u2069`:s;
const walk=root=>{const w=document.createTreeWalker(root,NodeFilter.SHOW_TEXT,null,false);let n;while((n=w.nextNode())){const t=n.nodeValue;if(!t)continue;if(t.includes("&#")||t.includes("8226#&")||t.includes("&amp;#"))n.nodeValue=decode(t);}};return{apply:(root=document)=>walk(root),fixTitle:(ar,en)=>decode(`${iso(ar)}${ar?" â€¢ ":""}${en}`),fixBadge:(t)=>decode(t),decode};})();

const toast=(root,msg)=>{const t=root._toast;if(!t)return;t.textContent=msg;t.style.display="block";clearTimeout(t._to);t._to=setTimeout(()=>t.style.display="none",2200);};
const fmt=s=>{s=Math.max(0,Math.floor(s||0));const m=Math.floor(s/60),r=s%60;return`${m}:${String(r).padStart(2,"0")}`;};
const pad3=n=>String(n).padStart(3,"0");
const audioUrl=(qari,surah,ayah)=>`https://everyayah.com/data/${qari}/${pad3(surah)}${pad3(ayah)}.mp3`;

const ICON={play:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`,
pause:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>`,
copy:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1zm4 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h12v14z"/></svg>`,
share:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7a2.5 2.5 0 0 0 0-1.39l7-4.11A2.99 2.99 0 1 0 14 5a3 3 0 0 0 .04.49l-7 4.11a3 3 0 1 0 0 4.8l7.12 4.17c-.03.15-.04.3-.04.45a3 3 0 1 0 3-3z"/></svg>`,
star:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>`,
moon:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 1 0 9.79 9.79z"/></svg>`,
kid:`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4.42 0-8 2-8 4.5V21h16v-2.5C20 16 16.42 14 12 14z"/></svg>`};

async function fetchAyahPack(surah,trans,tl){const url=`https://api.alquran.cloud/v1/surah/${surah}/editions/quran-simple-enhanced,${encodeURIComponent(trans)},${encodeURIComponent(tl)}`;const r=await fetch(url,{cache:"no-store"});if(!r.ok)throw new Error("API fail");const j=await r.json();const packs=j.data||[];const arab=packs.find(x=>x.edition?.identifier==="quran-simple-enhanced");const msx=packs.find(x=>x.edition?.identifier===trans);const tlx=packs.find(x=>x.edition?.identifier===tl);const ayahs=(arab?.ayahs||[]).map((a,i)=>({n:i+1,arab:a.text||"",ms:(msx?.ayahs?.[i]?.text||""),tl:(tlx?.ayahs?.[i]?.text||"")}));const meta={surah:arab?.number||surah,nameAr:arab?.name||"",nameEn:arab?.englishName||"",ayahCount:arab?.numberOfAyahs||ayahs.length,revelation:arab?.revelationType||""};return{meta,ayahs};}

function sabotage(root){root.innerHTML=`<div class="wrap"><div class="card"><div class="hero"><div class="t"><div style="font-size:1.5rem">ğŸ”’</div><div><h2>Micro Quran Trainer</h2><p>Akses dikunci untuk domain rasmi. Sila guna di ${OWNER}.</p><span class="badge">Â© ${OWNER}</span></div></div></div></div></div>`;}

function render(root){
root.innerHTML=`<div class="wrap"><div class="card">
<div class="hero"><div class="t"><div style="font-size:1.6rem">ğŸ§</div><div>
<h2 id="qtTitle">Micro Quran Trainer</h2>
<p id="qtDesc">Ruqyah â€¢ Hafazan â€¢ Kanak-kanak â€¢ Audio ayat demi ayat (surah pendek).</p>
<div class="badge" id="qtBadge">Â© IlmuAlam.com â€¢ Quran</div>
</div></div></div>

<div class="topbar">
<div class="player"><button class="pp" type="button" data-act="pp">${ICON.play}</button>
<div class="prog"><div class="bar"><i data-el="bar"></i></div>
<div class="meta"><span data-el="now">Ayat 1</span><span data-el="time">0:00 / 0:00</span></div></div>
<select class="select" data-el="qari">
<option value="Alafasy_128kbps" selected>M. R. Alafasy</option>
<option value="Husary_128kbps">M. K. Husary</option>
<option value="Abdurrahmaan_As-Sudais_192kbps">A. R. Sudais</option>
</select></div>

<div class="controls">
<button class="btn primary" type="button" data-act="ruqyah">ğŸ” Ruqyah 3x</button>
<span class="toggle"><input type="checkbox" data-el="slow">Slow</span>
<button class="btn" type="button" data-act="kids">${ICON.kid} Kids</button>
<button class="btn" type="button" data-act="night">${ICON.moon} Night</button>
<button class="btn ghost" type="button" data-act="emergency">ğŸš¨ Emergency</button>
</div></div>

<div class="tabs">
<button class="pill on" type="button" data-tab="all">Semua</button>
<button class="pill" type="button" data-tab="arab">Arab</button>
<button class="pill" type="button" data-tab="rumi">Rumi</button>
<button class="pill" type="button" data-tab="ms">Melayu</button>
</div>

<div class="stage"><div class="ayahbox" data-el="box">
<div class="mark">${OWNER}</div>
<div class="dots" data-el="dots"></div>
<div class="actrow">
<span class="ayahno" data-el="ayahno">Ayat 1</span>
<div class="mini">
<button class="iconbtn" type="button" data-act="copy">${ICON.copy}</button>
<button class="iconbtn" type="button" data-act="share">${ICON.share}</button>
<button class="iconbtn" type="button" data-act="save">${ICON.star}</button>
</div></div>
<div class="arab" data-el="arab">â€¦</div>
<div class="rumi" data-el="rumi">â€¦</div>
<div class="ms" data-el="ms">â€¦</div>
<div class="hint" data-el="hint" style="display:none">Swipe kiri/kanan untuk ayat seterusnya (Kids Mode).</div>
</div></div>

<div class="footer"><span>Â© <a class="a" href="${OWNER_URL}" rel="nofollow">IlmuAlam.com</a> â€¢ Micro Quran Trainer</span></div>
</div></div>
<div class="toast" data-el="toast"></div>
<audio data-el="audio" preload="metadata" crossorigin="anonymous"></audio>`;
}

function injectSchema(meta,root){
const url=location.href.split("#")[0];
if(document.querySelector('script[data-ilmqt-schema="1"]'))return;
const d=new Date(),pad=n=>String(n).padStart(2,"0");
const date=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const kw=[`surah ${String(meta.nameEn||"").toLowerCase()}`.trim(),`surah ${String(meta.nameEn||"").toLowerCase()} rumi`.trim(),`surah ${String(meta.nameEn||"").toLowerCase()} terjemahan melayu`.trim(),`surah ${String(meta.nameEn||"").toLowerCase()} audio`.trim(),"ruqyah 3 qul","ruqyah ikhlas falaq nas"].filter(Boolean);
const json={"@context":"https://schema.org","@graph":[
{"@type":"WebApplication","name":`Micro Quran Trainer â€¢ Surah ${meta.nameEn||meta.surah}`,"applicationCategory":"EducationalApplication","operatingSystem":"All","isAccessibleForFree":true,"url":url,"publisher":{"@type":"Organization","name":"IlmuAlam.com","url":OWNER_URL}},
{"@type":"Article","headline":`Surah ${meta.nameEn||meta.surah} â€¢ Rumi, Terjemahan Melayu & Audio`,"description":`Alat ruqyah & hafazan surah dengan audio ayat demi ayat, Arab + Rumi + terjemahan Melayu, mode perlahan, kids mode dan sambung ayat terakhir.`,"mainEntityOfPage":{"@type":"WebPage","@id":url},"datePublished":date,"dateModified":date,"author":{"@type":"Organization","name":"IlmuAlam.com","url":OWNER_URL},"publisher":{"@type":"Organization","name":"IlmuAlam.com","url":OWNER_URL},"keywords":kw}
]};
const s=document.createElement("script");s.type="application/ld+json";s.setAttribute("data-ilmqt-schema","1");s.textContent=JSON.stringify(json);document.head.appendChild(s);
}

function init(root){
if(!safeHost()){sabotage(root);return;}
render(root);
__ILM_FIX.apply(root);

const surahAttr=(root.getAttribute("data-surah")||"113").trim();
const trans=root.getAttribute("data-trans")||"ms.basmeih";
const tl=root.getAttribute("data-tl")||"en.transliteration";

const el=(q)=>root.querySelector(q);
const els={audio:el('[data-el="audio"]'),bar:el('[data-el="bar"]'),now:el('[data-el="now"]'),time:el('[data-el="time"]'),qari:el('[data-el="qari"]'),
pp:el('[data-act="pp"]'),box:el('[data-el="box"]'),dots:el('[data-el="dots"]'),ayahno:el('[data-el="ayahno"]'),arab:el('[data-el="arab"]'),
rumi:el('[data-el="rumi"]'),ms:el('[data-el="ms"]'),toast:el('[data-el="toast"]'),hint:el('[data-el="hint"]'),
title:el('#qtTitle'),badge:el('#qtBadge'),ruqyahBtn:el('[data-act="ruqyah"]'),slow:el('[data-el="slow"]')};
root._toast=els.toast;

const keyBase=`ilmqt_v1_${location.hostname}_${surahAttr}`;
let ayahs=[],meta=null,idx=0,tab="all",kids=false,ruqyahLoops=0,ruqyahMode=3,slow=false,userPaused=true,emergency=false,emergencyQueue=[],lastTouchX=null;

const setPlayIcon=(p)=>{els.pp.innerHTML=p?ICON.pause:ICON.play;};
const setTab=(t)=>{tab=t;root.querySelectorAll(".pill").forEach(b=>b.classList.toggle("on",b.getAttribute("data-tab")===t));
els.arab.style.display=(t==="all"||t==="arab")?"":"none";els.rumi.style.display=(t==="all"||t==="rumi")?"":"none";els.ms.style.display=(t==="all"||t==="ms")?"":"none";};

const saveState=()=>{localStorage.setItem(keyBase,JSON.stringify({idx,tab,kids,night:root.classList.contains("night"),slow,ruqyahMode}));};
const loadState=()=>{try{const st=JSON.parse(localStorage.getItem(keyBase)||"null");if(!st)return;idx=Math.max(0,Number(st.idx||0));setTab(st.tab||"all");kids=!!st.kids;root.classList.toggle("kids",kids);root.classList.toggle("night",!!st.night);slow=!!st.slow;els.slow.checked=slow;ruqyahMode=Number(st.ruqyahMode||3);}catch{}};

const updateDots=()=>{els.dots.innerHTML="";for(let i=0;i<ayahs.length;i++){const d=document.createElement("span");d.className="dot"+(i===idx?" on":"");els.dots.appendChild(d);}};

const setAyah=(i,hi=true)=>{idx=Math.min(Math.max(0,i),ayahs.length-1);const a=ayahs[idx];if(!a)return;
els.ayahno.textContent=`Ayat ${a.n}`;els.now.textContent=`Ayat ${a.n}`;
els.arab.textContent=a.arab||"";els.rumi.textContent=a.tl||"â€”";els.ms.textContent=a.ms||"â€”";
updateDots();if(hi){els.box.classList.add("hl");setTimeout(()=>els.box.classList.remove("hl"),500);}
els.hint.style.display=kids?"":"none";saveState();__ILM_FIX.apply(root);};

const loadAudio=(s,a,auto)=>{const q=els.qari.value||"Alafasy_128kbps";els.audio.src=audioUrl(q,s,a);
if(auto){userPaused=false;els.audio.play().catch(()=>toast(root,"Tekan play untuk mula (browser blok autoplay)."));}};

const stopAll=()=>{els.audio.pause();userPaused=true;setPlayIcon(false);els.bar.style.width="0%";els.time.textContent="0:00 / 0:00";};

const runEmergencyNext=()=>{const cur=emergencyQueue[0];if(!cur){emergency=false;toast(root,"Emergency selesai âœ…");return;}
if(idx<ayahs.length-1){setAyah(idx+1);loadAudio(meta.surah,idx+1,true);return;}
cur.loops--;if(cur.loops>0){setAyah(0);loadAudio(meta.surah,1,true);toast(root,`Emergency ulangan: ${cur.loops} lagi`);return;}
emergencyQueue.shift();const next=emergencyQueue[0];if(!next){emergency=false;toast(root,"Emergency selesai âœ…");stopAll();return;}
loadEmergencySurah(next.s).then(()=>{setAyah(0);loadAudio(meta.surah,1,true);});};

const nextAyah=(autoplay=true)=>{if(emergency){runEmergencyNext();return;}
if(idx<ayahs.length-1){setAyah(idx+1);loadAudio(meta.surah,idx+1,autoplay);return;}
if(ruqyahLoops>0){ruqyahLoops--;setAyah(0);loadAudio(meta.surah,1,autoplay);toast(root,`Ulangan ruqyah: ${ruqyahLoops} lagi`);return;}
stopAll();toast(root,"Tamat surah âœ…");};

const prevAyah=()=>{if(emergency){toast(root,"Emergency mode: guna Stop untuk keluar.");return;}
if(idx>0){setAyah(idx-1);loadAudio(meta.surah,idx+1,false);toast(root,"Ayat sebelumnya");}};

async function loadEmergencySurah(s){
const pack=await fetchAyahPack(s,trans,tl);meta=pack.meta;ayahs=pack.ayahs;
els.title.textContent=__ILM_FIX.fixTitle(meta.nameAr||"",meta.nameEn?`Surah ${meta.nameEn}`:`Surah ${meta.surah}`);
els.badge.textContent=__ILM_FIX.fixBadge(`Â© ${OWNER} â€¢ ${meta.revelation||"Quran"}`);
updateDots();setAyah(0,false);injectSchema(meta,root);}

async function startEmergency(){
emergency=true;stopAll();toast(root,"Emergency: Ikhlas + Falaq + Nas (3x)");
emergencyQueue=[{s:112,loops:3},{s:113,loops:3},{s:114,loops:3}];
await loadEmergencySurah(emergencyQueue[0].s);idx=0;setAyah(0,false);loadAudio(meta.surah,1,true);}

const setRuqyahBtn=()=>{els.ruqyahBtn.textContent=`ğŸ” Ruqyah ${ruqyahMode}x`;};
const toggleRuqyah=()=>{if(emergency){toast(root,"Emergency mode aktif.");return;}
ruqyahMode=(ruqyahMode===1)?3:(ruqyahMode===3?7:1);setRuqyahBtn();saveState();toast(root,`Ruqyah set: ${ruqyahMode}x`);};
const runRuqyahNow=()=>{if(emergency){toast(root,"Emergency mode aktif.");return;}
ruqyahLoops=ruqyahMode-1;toast(root,`Mulakan ruqyah ${ruqyahMode}x`);userPaused=false;loadAudio(meta.surah,idx+1,true);setPlayIcon(true);};

let pressT=null;
els.ruqyahBtn.addEventListener("touchstart",()=>{pressT=setTimeout(()=>runRuqyahNow(),520);},{passive:true});
els.ruqyahBtn.addEventListener("touchend",()=>{if(pressT){clearTimeout(pressT);pressT=null;}},{passive:true});
els.ruqyahBtn.addEventListener("mousedown",()=>{pressT=setTimeout(()=>runRuqyahNow(),520);});
els.ruqyahBtn.addEventListener("mouseup",()=>{if(pressT){clearTimeout(pressT);pressT=null;}});

root.querySelectorAll(".pill").forEach(b=>b.addEventListener("click",()=>setTab(b.getAttribute("data-tab"))));
root.addEventListener("click",(e)=>{
const b=e.target.closest("[data-act]");if(!b)return;const act=b.getAttribute("data-act");
if(act==="pp"){if(!els.audio.src){loadAudio(meta.surah,idx+1,true);setPlayIcon(true);return;}
if(els.audio.paused){userPaused=false;els.audio.play().then(()=>setPlayIcon(true)).catch(()=>toast(root,"Tekan play sekali lagi."));}
else{userPaused=true;els.audio.pause();setPlayIcon(false);} }
if(act==="copy"){const a=ayahs[idx];const txt=`Surah ${meta.nameEn||meta.surah} â€¢ Ayat ${a.n}\n${a.arab}\n${a.tl?`Rumi: ${a.tl}\n`:""}${a.ms?`Maksud: ${a.ms}\n`:""}\nâ€” ${OWNER} â€”`;navigator.clipboard?.writeText(txt).then(()=>toast(root,"Copied âœ…")).catch(()=>toast(root,"Copy gagal."));}
if(act==="share"){const a=ayahs[idx];const url=`${location.href.split("#")[0]}#ayat-${meta.surah}-${a.n}`;const title=`Surah ${meta.nameEn||meta.surah} â€¢ Ayat ${a.n}`;const text=(a.ms||a.tl||"").slice(0,160);
if(navigator.share){navigator.share({title,text,url}).catch(()=>{});}else{navigator.clipboard?.writeText(url).then(()=>toast(root,"Link copied âœ…")).catch(()=>toast(root,"Share tak support."));}}
if(act==="save"){const mk=`ilmqt_marks_${location.hostname}`;const marks=JSON.parse(localStorage.getItem(mk)||"{}");marks[`s${meta.surah}a${idx+1}`]={surah:meta.surah,ayah:idx+1,t:Date.now()};localStorage.setItem(mk,JSON.stringify(marks));toast(root,"Bookmark saved â­");}
if(act==="kids"){kids=!kids;root.classList.toggle("kids",kids);toast(root,kids?"Kids Mode ON (Swipe)":"Kids Mode OFF");saveState();}
if(act==="night"){root.classList.toggle("night");toast(root,root.classList.contains("night")?"Night ON":"Night OFF");saveState();}
if(act==="ruqyah"){toggleRuqyah();}
if(act==="emergency"){startEmergency().catch(()=>toast(root,"Emergency load fail."));}
});

els.slow.addEventListener("change",()=>{slow=!!els.slow.checked;toast(root,slow?"Slow ON":"Slow OFF");saveState();});
els.qari.addEventListener("change",()=>{const wasPlaying=!els.audio.paused&&!userPaused;loadAudio(meta.surah,idx+1,wasPlaying);toast(root,"Qari ditukar.");});

els.audio.addEventListener("timeupdate",()=>{const cur=els.audio.currentTime||0,dur=els.audio.duration||0;if(dur>0){els.bar.style.width=Math.min(100,(cur/dur)*100).toFixed(2)+"%";}els.time.textContent=`${fmt(cur)} / ${fmt(dur)}`;});
els.audio.addEventListener("ended",()=>{setPlayIcon(false);const go=()=>{setPlayIcon(true);nextAyah(true);};slow?setTimeout(go,900):go();});

const onTouchStart=e=>{lastTouchX=e.touches?.[0]?.clientX??null;};
const onTouchEnd=e=>{if(!kids)return;const x=e.changedTouches?.[0]?.clientX??null;if(lastTouchX==null||x==null)return;const dx=x-lastTouchX;if(Math.abs(dx)<40)return;dx<0?nextAyah(false):prevAyah();};
els.box.addEventListener("touchstart",onTouchStart,{passive:true});
els.box.addEventListener("touchend",onTouchEnd,{passive:true});

loadState();setRuqyahBtn();

const surahNum=(/^\d+$/.test(surahAttr))?Number(surahAttr):113;
fetchAyahPack(surahNum,trans,tl).then(pack=>{
meta=pack.meta;ayahs=pack.ayahs;
els.title.textContent=__ILM_FIX.fixTitle(meta.nameAr||"",meta.nameEn?`Surah ${meta.nameEn}`:`Surah ${meta.surah}`);
els.badge.textContent=__ILM_FIX.fixBadge(`Â© ${OWNER} â€¢ ${meta.revelation||"Quran"}`);
idx=Math.min(idx,ayahs.length-1);updateDots();setAyah(idx,false);

const m=location.hash.match(/ayat-(\d+)-(\d+)/);
if(m&&Number(m[1])===meta.surah){const target=Math.max(1,Number(m[2]||1));setAyah(target-1,true);}
injectSchema(meta,root);
}).catch(()=>{els.arab.textContent="Gagal memuatkan data. Cuba refresh.";toast(root,"API error. Cuba refresh.");});
}

document.querySelectorAll(".ilmqt").forEach(init);
})();
